<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Menalmei ‚Ä¢ Painel do Investidor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--gold:#d4af37;
--card:#151515;
--border:#2a2a2a;
--muted:#9a9a9a;
}

*{ box-sizing:border-box }

body{
margin:0;
background:radial-gradient(circle at top,#1a1a1a,#000);
font-family:Arial,Helvetica,sans-serif;
color:#fff;
}

.login{
height:100vh;
display:flex;
justify-content:center;
align-items:center;
}

.login-box{
background:var(--card);
padding:35px;
border-radius:20px;
border:1px solid var(--border);
width:320px;
text-align:center;
}

.login-box img{ width:120px; margin-bottom:15px; }

.login-box input,
.login-box button{
width:100%;
padding:12px;
border-radius:10px;
border:none;
margin-top:10px;
}

.login-box button{
background:var(--gold);
font-weight:bold;
cursor:pointer;
}

.erro{ color:#ff6b6b;font-size:13px }

.painel{ display:none }

header{
text-align:center;
padding:20px;
}

header img{ width:130px }

.sair{
margin-top:10px;
background:#1f1f1f;
color:var(--gold);
border:1px solid var(--border);
padding:8px 90px;
border-radius:10px;
cursor:pointer;
}

.card{
background:linear-gradient(180deg,#141414,#0a0a0a);
border:1px solid var(--border);
border-radius:20px;
max-width:1100px;
margin:20px auto;
padding:30px;
}

.grid,.cards-investidor{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
gap:18px;
}

.item{
background:var(--card);
border:1px solid var(--border);
padding:18px;
border-radius:14px;
transition:0.4s;
}

.item span{ color:var(--muted);font-size:13px }
.item strong{ display:block;margin-top:6px;font-size:20px }

.destaque{
animation:piscar 1s ease;
}

@keyframes piscar{
0%{ background:#1f1f1f }
100%{ background:var(--card) }
}

.progress-bar{
margin-top:20px;
height:30px;
background:#1f1f1f;
border-radius:20px;
overflow:hidden;
}

.progress{
height:100%;
background:linear-gradient(90deg,#a8872f,var(--gold));
width:0%;
transition:0.6s;
}

.simulador{
margin-top:30px;
}

.simulador input,
.simulador button{
width:100%;
padding:12px;
border-radius:10px;
border:none;
margin-top:10px;
}

.simulador button{
background:var(--gold);
font-weight:bold;
cursor:pointer;
}

.botao-historico{
margin-top:25px;
width:100%;
padding:12px;
border-radius:12px;
background:#1f1f1f;
color:var(--gold);
border:1px solid var(--border);
cursor:pointer;
font-weight:bold;
}

table{
width:100%;
border-collapse:collapse;
margin-top:20px;
}

th,td{
padding:10px;
border-bottom:1px solid var(--border);
}

th{ color:var(--gold);font-size:13px }

@media print{
  body{
    background:#fff;
    color:#000;
  }

  .login,
  .botao-historico,
  .simulador,
  header,
  .progress-bar,
  .grid,
  .cards-investidor{
    display:none !important;
  }

  .card{
    border:none;
    box-shadow:none;
  }

  table{
    width:100%;
  }

  th{
    color:#000;
  }
}

.loading-overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.loading-box{
  background:#151515;
  border:1px solid #2a2a2a;
  padding:30px 40px;
  border-radius:18px;
  text-align:center;
}

.loading-box p{
  margin-top:15px;
  color:#d4af37;
  font-weight:bold;
}

.spinner{
  width:45px;
  height:45px;
  border:4px solid #2a2a2a;
  border-top:4px solid #d4af37;
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:auto;
}

@keyframes spin{
  from{ transform:rotate(0deg); }
  to{ transform:rotate(360deg); }
}

.progress{
  height:100%;
  background:linear-gradient(90deg,#a8872f,var(--gold));
  width:0%;
  transition:0.6s;

  /* NOVO */
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: #000;
}

#textoBarra{
  position: absolute;
  font-size: 12px;
  color: #000;
}

.progress span{
  position: absolute;
  white-space: nowrap;
}

</style>

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.js" async=""></script>
<script>
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(function() {
    OneSignal.init({
      appId: "5969d4f4-e755-4a55-946c-7bfcc0c5f577",
    });
  });
</script>


</head>

<body>

<div class="login" id="login">
<div class="login-box">
<img src="logotipo.png">
<input id="cpf" placeholder="CPF">
<input id="senha" type="password" placeholder="Senha">
<button onclick="entrar()">Entrar</button>
<div class="erro" id="erro"></div>
</div>
</div>

<div class="painel" id="painel">
<header>
<img src="logotipo.png">
<h3 id="nomeUsuario"></h3>
<button class="sair" onclick="sair()">Sair</button>
</header>

<h2 id="nomeInvestimento" style="text-align:center;color:#d4af37;margin-bottom:25px;"></h2>

<section class="card">

<div class="grid">
<div class="item"><span>Valor da A√ß√£o</span><strong id="valorAcao"></strong></div>
<div class="item"><span>Dispon√≠vel para Investir</span><strong id="disponivel"></strong></div>
<div class="item"><span>Retorno da A√ß√£o</span><strong id="retornoAcao"></strong></div>
<div class="item"><span>In√≠cio</span><strong id="inicio"></strong></div>
<div class="item"><span>T√©rmino</span><strong id="termino"></strong></div>
</div>

<div class="progress-bar">
  <div class="progress" id="barra">
    <span id="textoBarra">0%</span>
  </div>
</div>

<div class="simulador">
<h3>Simulador de Retorno</h3>
<input type="number" id="valorSim" placeholder="Valor para investir (R$)">
<button onclick="simular()">Simular</button>
<p id="resultado"></p>
</div>

<h3 style="text-align:center;color:var(--gold);margin:30px 0">
ACOMPANHE SEU INVESTIMENTO
</h3>

<div class="cards-investidor">
<div class="item" id="cardInvestido">
<span>Total Investido</span><strong id="totalInvestido"></strong>
</div>
<div class="item destaque" id="cardRecebido">
<span>Total Recebido</span><strong id="totalRecebido"></strong>
</div>
</div>

<button class="botao-historico" onclick="toggleHistorico()">
Ver hist√≥rico de recebimentos
</button>

<button class="botao-historico" onclick="enviarPdf()">
üìÑ Enviar hist√≥rico por e-mail
</button>


<div id="historico" style="display:none">
<table>
<thead>
<tr>
<th>Transa√ß√£o</th>
<th>Recebido</th>
<th>Data</th>
<th>Hora</th>
</tr>
</thead>
<tbody id="tabelaHistorico"></tbody>
</table>
</div>

</section>
</div>

<script>
const URL="https://script.google.com/macros/s/AKfycbzRDaE9b14q_q93gNgB0NJqmm5O4I1OvxkDEL6g3Q1mNqsIeJj0wx3oV7q_08NKDsfs/exec";
let retornoPct=0;
let ultimoTotal=0;

function entrar(){
  erro.innerText = "";
  loading.style.display = "flex";
  document.querySelector(".loading-box p").innerText = "Verificando credenciais...";

  fetch(`${URL}?cpf=${cpf.value}&senha=${senha.value}`)
    .then(r => r.json())
    .then(d => {
      loading.style.display = "none";

      if(d.erro){
        erro.innerText = d.erro;
        return;
      }

      login.style.display = "none";
      painel.style.display = "block";

// Solicitar permiss√£o de notifica√ß√£o
if (window.OneSignal) {
  OneSignal.push(function() {
    OneSignal.showSlidedownPrompt();
  });
}

      atualizarPainel(d);

      setInterval(() => {
        fetch(`${URL}?cpf=${cpf.value}&senha=${senha.value}`)
          .then(r => r.json())
          .then(atualizarPainel);
      }, 5000);
    })
    .catch(err => {
      loading.style.display = "none";
      erro.innerText = "Erro ao conectar ao servidor";
      console.error(err);
    });
}

function atualizarPainel(d){
  nomeUsuario.innerText = "Ol√°, " + d.usuario.nome;
  nomeInvestimento.innerText = d.investimento.nome;

  valorAcao.innerText = "R$ " + d.investimento.valorAcao.toFixed(2);
  disponivel.innerText = "R$ " + d.investimento.disponivelInvestir.toFixed(2);
  retornoAcao.innerText = d.investimento.retornoAcao + "%";
  inicio.innerText = d.investimento.inicio;
  termino.innerText = d.investimento.termino;

  // Configurar OneSignal para este usu√°rio pelo CPF
  if (window.OneSignal) {
    OneSignal.push(function () {
      OneSignal.setExternalUserId(cpf.value); // identifica o investidor
    });
  }

  // Atualiza barra de progresso
  const percentual = Math.min(
    (d.investimento.totalInvestidoAcao / d.investimento.valorAcao) * 100,
    100
  );

  barra.style.width = percentual + "%";

  if (percentual >= 100) {
    textoBarra.innerText = "üöÄ INVESTIMENTO ENCERRADO";
    barra.style.background = "linear-gradient(90deg,#00c853,#00e676)";
  } else {
    textoBarra.innerText =
      percentual.toFixed(1) + "% ‚Ä¢ R$ " +
      d.investimento.totalInvestidoAcao.toFixed(2) +
      " de R$ " +
      d.investimento.valorAcao.toFixed(2);
  }

  totalInvestido.innerText = "R$ " + d.usuario.investimento.toFixed(2);
  
  // DETECTAR NOVO RECEBIMENTO
  if(d.totalRecebido > ultimoTotal){
    const valorRecebido = d.totalRecebido - ultimoTotal;
    cardRecebido.classList.add("destaque");
    setTimeout(() => cardRecebido.classList.remove("destaque"), 1000);

    // Enviar notifica√ß√£o push
    if (window.OneSignal) {
      OneSignal.push(function() {
        OneSignal.sendSelfNotification(
          "Novo recebimento!",
          `Voc√™ recebeu R$ ${valorRecebido.toFixed(2)} no seu investimento.`,
          window.location.href,
          'https://seusite.com/logo.png' // coloque o caminho da sua logo
        );
      });
    }
  }

  ultimoTotal = d.totalRecebido;

  // Atualiza tabela de hist√≥rico
  tabelaHistorico.innerHTML = "";
  d.historico.forEach(h => {
    tabelaHistorico.innerHTML += `
      <tr>
        <td>${h.transacao}</td>
        <td>R$ ${h.recebido.toFixed(2)}</td>
        <td>${h.data}</td>
        <td>${h.hora}</td>
      </tr>`;
  });

  retornoPct = d.investimento.retornoAcao;
}


function toggleHistorico(){
historico.style.display=historico.style.display==="none"?"block":"none";
}

function simular(){
const v=parseFloat(valorSim.value);
if(!v) return;
const lucro=v*(retornoPct/100);
resultado.innerText=`Total estimado: R$ ${(v+lucro).toFixed(2)} (lucro R$ ${lucro.toFixed(2)})`;
}

function sair(){
location.reload();
}

function enviarPdf(){
  loading.style.display="flex";
  document.querySelector(".loading-box p").innerText =
    "Enviando relat√≥rio para seu e-mail...";

  fetch(`${URL}?cpf=${cpf.value}&senha=${senha.value}&acao=pdf`)
    .then(r => r.json())
    .then(d => {
      loading.style.display="none";

      if(d.erro){
        alert("Erro: " + d.erro);
      } else {
        alert("üìß PDF enviado com sucesso para seu e-mail!");
      }
    })
    .catch(err => {
      loading.style.display="none";
      alert("Erro ao gerar PDF");
      console.error(err);
    });
}

</script>

<div id="loading" class="loading-overlay">
  <div class="loading-box">
    <div class="spinner"></div>
    <p>Enviando relat√≥rio para seu e-mail‚Ä¶</p>
  </div>
</div>

</body>
</html>
